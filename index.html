<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Skybound Runner - 2D Platformer</title>
<script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
<style>
  :root{
    --bg1:#0c1224;
    --bg2:#1c2a4a;
    --accent:#ffcc00;
    --accent2:#ff6a3d;
    --panel:#0b1120cc;
    --text:#e8f0ff;
    --soft:#9fb3ff;
    --good:#79ffa8;
    --bad:#ff6b81;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    background: linear-gradient(180deg, var(--bg1), var(--bg2));
    color:var(--text);
    overflow:hidden;
    user-select:none;
    touch-action:none;
  }
  #game{
    position:relative; width:100vw; height:100vh; overflow:hidden;
  }
  canvas{ display:block; width:100%; height:100%; background: radial-gradient(120% 120% at 50% 10%, #1d3b7c 0%, #0d1630 60%, #0a1024 100%) }
  #hud{
    position:absolute; top:12px; left:12px; z-index:5; display:flex; gap:12px; align-items:center; font-weight:700;
    text-shadow:0 2px 10px rgba(0,0,0,0.5);
  }
  #hud .stat{ background: rgba(0,0,0,0.25); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06) }
  #hud .coin{
    display:inline-flex; align-items:center; gap:6px;
  }
  #hud .dot{ width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #fff7b0, #f7b500 60%, #b97f00 100%); box-shadow:0 0 10px #f7b500aa }
  #hud .btn{
    margin-left:6px; cursor:pointer; border:none; border-radius:10px; background:rgba(0,0,0,0.25); color:var(--text); padding:8px 12px; font-weight:700;
    border:1px solid rgba(255,255,255,0.06)
  }
  #hud .btn:active{ transform:scale(0.98) }
  #pauseBtn{ margin-left:6px; }
  
  .overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:10; padding:20px;
    background: radial-gradient(120% 120% at 50% 40%, #0b122a66 0%, #050914bb 35%, #020814ee 100%);
    backdrop-filter: blur(4px);
  }
  .panel{
    width:min(680px, 94vw);
    background: var(--panel);
    border:1px solid rgba(255,255,255,0.08);
    box-shadow: 0 20px 70px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.04);
    border-radius:16px; padding:22px;
    text-align:center;
  }
  .title{
    font-size: clamp(24px, 4vw, 40px);
    margin:6px 0 10px 0;
    background: linear-gradient(90deg, #9fc5ff, #fff, #9fc5ff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow:none;
  }
  .subtitle{ color: var(--soft); margin:2px 0 16px 0 }
  .actions{ display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:14px }
  .btnPrimary{
    background: linear-gradient(180deg, #3a7bff, #2256d6);
    color:white; border:none; border-radius:12px; padding:12px 18px; font-weight:800; cursor:pointer;
    box-shadow: 0 10px 30px rgba(43,98,255,0.35);
  }
  .btnPrimary:active{ transform:translateY(1px) scale(0.99) }
  .btnSecondary{
    background: linear-gradient(180deg, #4a4f5e, #2d3140);
    color:white; border:none; border-radius:12px; padding:12px 18px; font-weight:800; cursor:pointer;
    border:1px solid rgba(255,255,255,0.1);
  }
  .small{ font-size:12px; opacity:0.8 }
  ul.keylist{ text-align:left; margin:0 auto; width: fit-content; padding-left: 18px; line-height:1.5 }
  .kbd{
    display:inline-block; padding:2px 6px; border-radius:6px; background:#0f1a3a; border:1px solid rgba(255,255,255,0.1); font-weight:700
  }
  
  /* Settings Panel Styles */
  .settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .settings-row:last-child {
    border-bottom: none;
  }
  .settings-label {
    font-weight: 600;
  }
  .select-wrapper {
    position: relative;
    min-width: 140px;
  }
  .select-wrapper select {
    width: 100%;
    background: rgba(0,0,0,0.3);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 8px 12px;
    font-weight: 600;
    appearance: none;
    cursor: pointer;
  }
  .checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .checkbox-custom {
    width: 20px;
    height: 20px;
    border-radius: 5px;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .checkbox-custom.checked {
    background: #3a7bff;
  }
  .checkbox-custom.checked::after {
    content: "‚úì";
    color: white;
    font-weight: bold;
  }
  
  #touchControls{
    position:absolute; inset:auto 0 12px 0; z-index:7; display:grid; grid-template-columns:1fr auto 1fr; gap:16px; align-items:end; padding:0 12px; pointer-events:none;
  }
  .tcGroup{ display:flex; gap:12px; justify-content:flex-start; pointer-events:auto }
  .tcGroup.right{ justify-content:flex-end }
  .tcBtn{
    width:70px; height:70px; border-radius:50%; border:none; background: radial-gradient(100% 100% at 30% 20%, #243665, #0d1b3a);
    color:#ddecff; font-weight:900; font-size:18px; box-shadow:0 8px 30px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.06);
    display:flex; align-items:center; justify-content:center; opacity:0.94;
  }
  .tcBtn:active{ transform:scale(0.98) }
  @media (min-width: 900px) and (hover:hover){
    #touchControls{ display:none }
  }
  .fade{ animation: fadein 0.3s ease both }
  @keyframes fadein{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
  .pulse{
    animation: pulse 1.3s ease-in-out infinite;
  }
  @keyframes pulse{ 0%{ transform:scale(1) } 50%{ transform:scale(1.06) } 100%{ transform:scale(1) } }
  .hidden{ display:none !important }
  a{ color:#a3c5ff }
</style>
</head>
<body>
  <div id="game">
    <canvas id="canvas"></canvas>

    <div id="hud">
      <div class="stat coin"><span class="dot"></span> <span id="coinCount">0</span></div>
      <div class="stat">Time <span id="time">0.0</span>s</div>
      <div class="stat">Best <span id="best">‚Äî</span></div>
      <button id="muteBtn" class="btn" title="Toggle Sound">üîä</button>
      <button id="pauseBtn" class="btn" title="Pause">‚è∏</button>
      <button id="restartBtn" class="btn" title="Restart">‚ü≤</button>
    </div>

    <div id="startOverlay" class="overlay">
      <div class="panel fade">
        <div class="title" data-i18n="gameTitle">Skybound Runner</div>
        <div class="subtitle" data-i18n="gameSubtitle">A fast, punchy 2D platformer. Collect coins, avoid spikes, reach the goal!</div>
        <ul class="keylist">
          <li><span data-i18n="controlMove">Move</span>: <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> or <span class="kbd">A</span>/<span class="kbd">D</span></li>
          <li><span data-i18n="controlJump">Jump</span>: <span class="kbd">Space</span> or <span class="kbd">W</span>/<span class="kbd">‚Üë</span> (<span data-i18n="doubleJump">double jump enabled</span>)</li>
          <li><span data-i18n="controlRestart">Restart</span>: <span class="kbd">R</span></li>
          <li><span data-i18n="controlPause">Pause</span>: <span class="kbd">P</span> or <span class="kbd">ESC</span></li>
        </ul>
        <div class="actions">
          <button id="startBtn" class="btnPrimary pulse" data-i18n="startButton">Tap or Press Space to Start</button>
          <button id="settingsBtn" class="btnSecondary" data-i18n="settingsButton">Settings</button>
        </div>
        <div class="small" style="margin-top:10px" data-i18n="mobileHint">Works on mobile. Use on-screen controls.</div>
      </div>
    </div>

    <div id="pauseOverlay" class="overlay hidden">
      <div class="panel fade">
        <div class="title">‚è∏ <span data-i18n="paused">Game Paused</span></div>
        <div class="subtitle" data-i18n="pausedSubtitle">Take a break, adjust settings, or continue your run</div>
        <div class="actions">
          <button id="resumeBtn" class="btnPrimary" data-i18n="resumeButton">Resume Game</button>
          <button id="settingsBtn2" class="btnSecondary" data-i18n="settingsButton">Settings</button>
          <button id="quitBtn" class="btnSecondary" data-i18n="quitButton">Quit to Menu</button>
        </div>
      </div>
    </div>

    <div id="settingsOverlay" class="overlay hidden">
      <div class="panel fade">
        <div class="title">‚öôÔ∏è <span data-i18n="settingsTitle">Settings</span></div>
        
        <div class="settings-row">
          <div class="settings-label" data-i18n="languageLabel">Language</div>
          <div class="select-wrapper">
            <select id="languageSelect">
              <option value="en" data-i18n="langEnglish">English</option>
              <option value="fr" data-i18n="langFrench">Fran√ßais</option>
              <option value="ar" data-i18n="langArabic">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-label" data-i18n="mobileControlsLabel">Mobile Controls</div>
          <div class="checkbox-wrapper" id="mobileControlsToggle">
            <div class="checkbox-custom checked"></div>
            <span data-i18n="mobileControlsToggle">Show on-screen controls</span>
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-label" data-i18n="soundLabel">Sound</div>
          <div class="checkbox-wrapper" id="soundToggle">
            <div class="checkbox-custom checked"></div>
            <span data-i18n="soundToggle">Enable sound effects</span>
          </div>
        </div>
        
        <div class="settings-row">
          <div class="settings-label" data-i18n="particlesLabel">Particles</div>
          <div class="checkbox-wrapper" id="particlesToggle">
            <div class="checkbox-custom checked"></div>
            <span data-i18n="particlesToggle">Show particle effects</span>
          </div>
        </div>
        
        <div class="actions" style="margin-top:24px">
          <button id="backBtn" class="btnPrimary" data-i18n="backButton">Back</button>
          <button id="saveBtn" class="btnSecondary" data-i18n="saveButton">Save & Apply</button>
        </div>
      </div>
    </div>

    <div id="winOverlay" class="overlay hidden">
      <div class="panel fade">
        <div class="title" data-i18n="winTitle">You Win! üèÅ</div>
        <div class="subtitle" data-i18n="winSubtitle">Nice run.</div>
        <div id="winStats"></div>
        <div class="actions">
          <button id="againBtn" class="btnPrimary" data-i18n="playAgainButton">Play Again</button>
          <button id="menuBtn" class="btnSecondary" data-i18n="menuButton">Main Menu</button>
        </div>
      </div>
    </div>

    <div id="overOverlay" class="overlay hidden">
      <div class="panel fade">
        <div class="title" data-i18n="gameOverTitle">Game Over üí•</div>
        <div class="subtitle" data-i18n="gameOverSubtitle">You fell or hit something sharp!</div>
        <div id="overStats"></div>
        <div class="actions">
          <button id="tryBtn" class="btnPrimary" data-i18n="tryAgainButton">Try Again</button>
          <button id="menuBtn2" class="btnSecondary" data-i18n="menuButton">Main Menu</button>
        </div>
      </div>
    </div>

    <div id="touchControls">
      <div class="tcGroup">
        <button id="btnLeft" class="tcBtn">‚üµ</button>
        <button id="btnRight" class="tcBtn">‚ü∂</button>
      </div>
      <div></div>
      <div class="tcGroup right">
        <button id="btnJump" class="tcBtn">‚ü∞</button>
      </div>
    </div>
  </div>

<script>
(()=>{
  // --- CRAZY GAMES SDK INITIALIZATION ---
  let crazySDK = null;
  window.addEventListener('load', () => {
    if (window.CrazyGames && window.CrazyGames.SDK) {
      crazySDK = window.CrazyGames.SDK;
    }
  });

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // UI Elements
  const hudCoin = document.getElementById('coinCount');
  const hudTime = document.getElementById('time');
  const hudBest = document.getElementById('best');
  const startOverlay = document.getElementById('startOverlay');
  const pauseOverlay = document.getElementById('pauseOverlay');
  const settingsOverlay = document.getElementById('settingsOverlay');
  const winOverlay = document.getElementById('winOverlay');
  const overOverlay = document.getElementById('overOverlay');
  const winStats = document.getElementById('winStats');
  const overStats = document.getElementById('overStats');
  
  // Buttons
  const startBtn = document.getElementById('startBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsBtn2 = document.getElementById('settingsBtn2');
  const pauseBtn = document.getElementById('pauseBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const quitBtn = document.getElementById('quitBtn');
  const backBtn = document.getElementById('backBtn');
  const saveBtn = document.getElementById('saveBtn');
  const againBtn = document.getElementById('againBtn');
  const tryBtn = document.getElementById('tryBtn');
  const menuBtn = document.getElementById('menuBtn');
  const menuBtn2 = document.getElementById('menuBtn2');
  const muteBtn = document.getElementById('muteBtn');
  const restartBtn = document.getElementById('restartBtn');
  
  // Settings Elements
  const languageSelect = document.getElementById('languageSelect');
  const mobileControlsToggle = document.getElementById('mobileControlsToggle');
  const soundToggle = document.getElementById('soundToggle');
  const particlesToggle = document.getElementById('particlesToggle');
  
  // Touch Controls
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnJump = document.getElementById('btnJump');

  let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const resize = ()=>{
    const w = Math.floor(window.innerWidth);
    const h = Math.floor(window.innerHeight);
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
  };
  window.addEventListener('resize', resize, {passive:true});
  resize();

  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const rand = (a,b)=>a + Math.random()*(b-a);
  const irand = (a,b)=>Math.floor(rand(a,b+1));
  const sign = (x)=>x<0?-1:1;

  // Game Settings
  const gameSettings = {
    language: localStorage.getItem('skybound_lang') || 'en',
    mobileControls: localStorage.getItem('skybound_mobile') !== 'false',
    sound: localStorage.getItem('skybound_sound') !== 'false',
    particles: localStorage.getItem('skybound_particles') !== 'false'
  };

  // Internationalization (Keep your dict)
  const translations = {
    en: { gameTitle: "Skybound Runner", gameSubtitle: "A fast, punchy 2D platformer. Collect coins, avoid spikes, reach the goal!", controlMove: "Move", controlJump: "Jump", controlRestart: "Restart", controlPause: "Pause", doubleJump: "double jump enabled", startButton: "Tap or Press Space to Start", settingsButton: "Settings", mobileHint: "Works on mobile. Use on-screen controls.", paused: "Game Paused", pausedSubtitle: "Take a break, adjust settings, or continue your run", resumeButton: "Resume Game", quitButton: "Quit to Menu", settingsTitle: "Settings", languageLabel: "Language", mobileControlsLabel: "Mobile Controls", mobileControlsToggle: "Show on-screen controls", soundLabel: "Sound", soundToggle: "Enable sound effects", particlesLabel: "Particles", particlesToggle: "Show particle effects", backButton: "Back", saveButton: "Save & Apply", winTitle: "You Win! üèÅ", winSubtitle: "Nice run.", playAgainButton: "Play Again", menuButton: "Main Menu", gameOverTitle: "Game Over üí•", gameOverSubtitle: "You fell or hit something sharp!", tryAgainButton: "Try Again", langEnglish: "English", langFrench: "Fran√ßais", langArabic: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©" },
    fr: { gameTitle: "Skybound Runner", gameSubtitle: "Un platformer 2D rapide et dynamique. Collectionnez les pi√®ces, √©vitez les pics, atteignez le but !", controlMove: "D√©placement", controlJump: "Sauter", controlRestart: "Recommencer", controlPause: "Pause", doubleJump: "double saut activ√©", startButton: "Cliquez ou appuyez sur Espace pour d√©marrer", settingsButton: "Param√®tres", mobileHint: "Fonctionne sur mobile. Utilisez les contr√¥les √† l'√©cran.", paused: "Jeu en Pause", pausedSubtitle: "Faites une pause, ajustez les param√®tres ou continuez votre course", resumeButton: "Reprendre le Jeu", quitButton: "Quitter vers le Menu", settingsTitle: "Param√®tres", languageLabel: "Langue", mobileControlsLabel: "Contr√¥les Mobile", mobileControlsToggle: "Afficher les contr√¥les √† l'√©cran", soundLabel: "Son", soundToggle: "Activer les effets sonores", particlesLabel: "Particules", particlesToggle: "Afficher les effets de particules", backButton: "Retour", saveButton: "Sauvegarder & Appliquer", winTitle: "Vous avez gagn√© ! üèÅ", winSubtitle: "Belle course.", playAgainButton: "Rejouer", menuButton: "Menu Principal", gameOverTitle: "Game Over üí•", gameOverSubtitle: "Vous √™tes tomb√© ou avez touch√© quelque chose de pointu !", tryAgainButton: "R√©essayer", langEnglish: "Anglais", langFrench: "Fran√ßais", langArabic: "Arabe" },
    ar: { gameTitle: "ÿ≥ŸÉÿßŸä ÿ®ÿßŸàŸÜÿØ ÿ±ÿßŸÜÿ±", gameSubtitle: "ŸÑÿπÿ®ÿ© ŸÖŸÜÿµÿßÿ™ ÿ´ŸÜÿßÿ¶Ÿäÿ© ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿ≥ÿ±Ÿäÿπÿ© ŸàŸÖÿ´Ÿäÿ±ÿ©. ÿßÿ¨ŸÖÿπ ÿßŸÑÿπŸÖŸÑÿßÿ™ÿå ÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÖÿ≥ÿßŸÖŸäÿ±ÿå ŸàÿµŸÑ ÿ•ŸÑŸâ ÿßŸÑŸáÿØŸÅ!", controlMove: "ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÉ", controlJump: "ÿßŸÑŸÇŸÅÿ≤", controlRestart: "ÿ•ÿπÿßÿØÿ©", controlPause: "ÿ•ŸäŸÇÿßŸÅ ŸÖÿ§ŸÇÿ™", doubleJump: "ÿßŸÑŸÇŸÅÿ≤ ÿßŸÑŸÖÿ≤ÿØŸàÿ¨ ŸÖŸÅÿπŸÑ", startButton: "ÿßÿ∂ÿ∫ÿ∑ ÿ£Ÿà ÿßŸÑŸÖÿ≥ ŸÑÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©", settingsButton: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™", mobileHint: "ÿ™ÿπŸÖŸÑ ÿπŸÑŸâ ÿßŸÑŸáÿßÿ™ŸÅ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜÿßÿµÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ©.", paused: "ÿßŸÑŸÑÿπÿ®ÿ© ŸÖÿ™ŸàŸÇŸÅÿ©", pausedSubtitle: "ÿÆÿ∞ ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©ÿå ÿßÿ∂ÿ®ÿ∑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ÿå ÿ£Ÿà ÿ™ÿßÿ®ÿπ ÿ±ÿ≠ŸÑÿ™ŸÉ", resumeButton: "ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑŸÑÿπÿ®ÿ©", quitButton: "ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ•ŸÑŸâ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", settingsTitle: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™", languageLabel: "ÿßŸÑŸÑÿ∫ÿ©", mobileControlsLabel: "ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸáÿßÿ™ŸÅ", mobileControlsToggle: "ÿ•ÿ∏Ÿáÿßÿ± ÿπŸÜÿßÿµÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ©", soundLabel: "ÿßŸÑÿµŸàÿ™", soundToggle: "ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖÿ§ÿ´ÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©", particlesLabel: "ÿßŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™", particlesToggle: "ÿ•ÿ∏Ÿáÿßÿ± ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ¨ÿ≥ŸäŸÖÿßÿ™", backButton: "ÿ±ÿ¨Ÿàÿπ", saveButton: "ÿ≠ŸÅÿ∏ Ÿàÿ™ÿ∑ÿ®ŸäŸÇ", winTitle: "ŸÑŸÇÿØ ŸÅÿ≤ÿ™! üèÅ", winSubtitle: "ÿ£ÿØÿßÿ° ÿ±ÿßÿ¶ÿπ.", playAgainButton: "ÿßŸÑÿπÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", menuButton: "ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", gameOverTitle: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ© üí•", gameOverSubtitle: "ŸÑŸÇÿØ ÿ≥ŸÇÿ∑ÿ™ ÿ£Ÿà ÿßÿµÿ∑ÿØŸÖÿ™ ÿ®ÿ¥Ÿäÿ° ÿ≠ÿßÿØ!", tryAgainButton: "ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", langEnglish: "ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©", langFrench: "ÿßŸÑŸÅÿ±ŸÜÿ≥Ÿäÿ©", langArabic: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©" }
  };

  function updateLanguage(lang) {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[lang] && translations[lang][key]) {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = translations[lang][key];
        else el.textContent = translations[lang][key];
      }
    });
  }

  function loadSettings() {
    languageSelect.value = gameSettings.language;
    mobileControlsToggle.querySelector('.checkbox-custom').classList.toggle('checked', gameSettings.mobileControls);
    soundToggle.querySelector('.checkbox-custom').classList.toggle('checked', gameSettings.sound);
    particlesToggle.querySelector('.checkbox-custom').classList.toggle('checked', gameSettings.particles);
    updateLanguage(gameSettings.language);
    document.getElementById('touchControls').style.display = gameSettings.mobileControls ? 'grid' : 'none';
  }

  function saveSettings() {
    gameSettings.language = languageSelect.value;
    gameSettings.mobileControls = mobileControlsToggle.querySelector('.checkbox-custom').classList.contains('checked');
    gameSettings.sound = soundToggle.querySelector('.checkbox-custom').classList.contains('checked');
    gameSettings.particles = particlesToggle.querySelector('.checkbox-custom').classList.contains('checked');
    localStorage.setItem('skybound_lang', gameSettings.language);
    localStorage.setItem('skybound_mobile', gameSettings.mobileControls);
    localStorage.setItem('skybound_sound', gameSettings.sound);
    localStorage.setItem('skybound_particles', gameSettings.particles);
    updateLanguage(gameSettings.language);
    document.getElementById('touchControls').style.display = gameSettings.mobileControls ? 'grid' : 'none';
    muted = !gameSettings.sound;
    muteBtn.textContent = muted ? 'üîà' : 'üîä';
    showParticles = gameSettings.particles;
  }

  mobileControlsToggle.addEventListener('click', () => mobileControlsToggle.querySelector('.checkbox-custom').classList.toggle('checked'));
  soundToggle.addEventListener('click', () => soundToggle.querySelector('.checkbox-custom').classList.toggle('checked'));
  particlesToggle.addEventListener('click', () => particlesToggle.querySelector('.checkbox-custom').classList.toggle('checked'));

  // Audio System
  let audioReady = false;
  let muted = false;
  let audio;
  function initAudio(){
    if(audioReady) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    audio = new AC();
    audioReady = true;
  }
  async function resumeAudio(){
    try{
      if(!audioReady) initAudio();
      if(audio && audio.state === 'suspended') await audio.resume();
    }catch(e){}
  }
  function sfx(type){
    if(muted || !audioReady) return;
    const now = audio.currentTime;
    const master = audio.createGain();
    master.connect(audio.destination);
    master.gain.setValueAtTime(0.18, now);
    master.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
    function tone(freq, dur, t=now, type='sine', vol=1){
      const o = audio.createOscillator(); const g = audio.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.0001, t); g.gain.exponentialRampToValueAtTime(0.5*vol, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      o.connect(g); g.connect(master); o.start(t); o.stop(t + dur + 0.02);
    }
    if(type==='jump'){ tone(280,0.06,now,'square',0.8); tone(380,0.08,now+0.02,'triangle',0.6); }
    else if(type==='coin'){ tone(880,0.07,now,'square',0.9); tone(1320,0.07,now+0.02,'triangle',0.6); }
    else if(type==='death'){ tone(220,0.12,now,'sawtooth',0.7); tone(120,0.2,now+0.08,'square',0.5); }
    else if(type==='win'){ tone(523.25,0.1,now,'triangle',0.7); tone(659.25,0.1,now+0.08,'triangle',0.7); tone(783.99,0.2,now+0.16,'triangle',0.7); }
    else if(type==='land'){ tone(160,0.05,now,'sine',0.4); }
  }

  // Input Handling
  const input = { left:false, right:false, jump:false, jumpPressed:false, jumpBuffer:0, pointers:new Map() };
  const kmap = { left:['ArrowLeft','a','A'], right:['ArrowRight','d','D'], jump:['ArrowUp','w','W',' ','Spacebar'] };
  function setKey(e, down){
    const key = e.key;
    if(kmap.left.includes(key)) input.left = down;
    if(kmap.right.includes(key)) input.right = down;
    if(kmap.jump.includes(key)){ if(down){ if(!input.jump) input.jumpPressed = true; input.jump = true; } else input.jump = false; }
    if(key==='r' || key==='R'){ if(down) restart(); }
    if(key==='m' || key==='M'){ if(down) toggleMute(); }
    if((key==='p' || key==='P' || key==='Escape' || key==='Esc') && down) togglePause();
    if(state==='playing') e.preventDefault();
  }
  window.addEventListener('keydown', e=>{ if(state!=='menu') resumeAudio(); setKey(e,true); if(state==='menu' && kmap.jump.includes(e.key)) startGame(); });
  window.addEventListener('keyup', e=>setKey(e,false));

  function bindButton(el, on, off){
    const start = (e)=>{ e.preventDefault(); e.stopPropagation(); on(); el.setAttribute('data-active','1'); };
    const end = (e)=>{ e.preventDefault(); e.stopPropagation(); off(); el.removeAttribute('data-active'); };
    el.addEventListener('pointerdown', start); window.addEventListener('pointerup', end); window.addEventListener('pointercancel', end); el.addEventListener('contextmenu', e=>e.preventDefault());
  }
  bindButton(btnLeft, ()=>{ input.left = true; }, ()=>{ input.left = false; });
  bindButton(btnRight, ()=>{ input.right = true; }, ()=>{ input.right = false; });
  bindButton(btnJump, ()=>{ if(!input.jump) input.jumpPressed = true; input.jump = true; }, ()=>{ input.jump = false; });

  // SDK Helper: Show Midroll Ad
  let adCooldown = false;
  function requestAd() {
    if (crazySDK && !adCooldown) {
      crazySDK.ad.requestAd('midroll', {
        adStarted: () => { state = 'paused'; },
        adFinished: () => { state = 'playing'; adCooldown = true; setTimeout(()=>adCooldown=false, 60000); },
        adError: () => { state = 'playing'; }
      });
    }
  }

  // UI Listeners
  startBtn.addEventListener('click', ()=>{ resumeAudio(); startGame(); });
  settingsBtn.addEventListener('click', showSettings);
  settingsBtn2.addEventListener('click', showSettings);
  pauseBtn.addEventListener('click', togglePause);
  resumeBtn.addEventListener('click', togglePause);
  quitBtn.addEventListener('click', quitToMenu);
  backBtn.addEventListener('click', hideSettings);
  saveBtn.addEventListener('click', ()=>{ saveSettings(); hideSettings(); if(state === 'paused') { hideAllOverlays(); state = 'playing'; } });
  againBtn.addEventListener('click', startGame);
  tryBtn.addEventListener('click', startGame);
  menuBtn.addEventListener('click', showMenu);
  menuBtn2.addEventListener('click', showMenu);
  muteBtn.addEventListener('click', toggleMute);
  restartBtn.addEventListener('click', ()=>restart());

  function toggleMute(){ muted = !muted; muteBtn.textContent = muted ? 'üîà' : 'üîä'; }
  function togglePause() {
    if(state === 'playing') {
      state = 'paused'; showOverlay(pauseOverlay);
      if(crazySDK) crazySDK.game.gameplayStop();
    } else if(state === 'paused') {
      state = 'playing'; hideAllOverlays();
      if(crazySDK) crazySDK.game.gameplayStart();
    }
  }
  function showSettings() { hideAllOverlays(); settingsOverlay.classList.remove('hidden'); loadSettings(); }
  function hideSettings() { settingsOverlay.classList.add('hidden'); if(state === 'paused') pauseOverlay.classList.remove('hidden'); }
  function quitToMenu() { state = 'menu'; hideAllOverlays(); startOverlay.classList.remove('hidden'); if(crazySDK) crazySDK.game.gameplayStop(); }
  function showMenu() { state = 'menu'; hideAllOverlays(); startOverlay.classList.remove('hidden'); if(crazySDK) crazySDK.game.gameplayStop(); }

  // Game Physics Constants
  const GRAVITY = 2000; const MOVE_ACCEL_GROUND = 2600; const MOVE_ACCEL_AIR = 1800; const MAX_RUN = 500; const FRICTION = 2300; const JUMP_VEL = 960; const COYOTE_TIME = 0.12; const JUMP_BUFFER = 0.12; const CUT_GRAVITY_MULT = 2.5;
  const PLAYER = { w:36, h:48 }; const WORLD = { width: 7000, height: 1200 };

  // Entities classes (Same as yours)
  class Platform { constructor(x,y,w,h,opts={}){ this.x=x; this.y=y; this.w=w; this.h=h; this.color = opts.color || '#23406f'; this.topColor = opts.topColor || '#2f5ca7'; this.move = opts.move || null; this.vx = 0; this.vy = 0; this.shadow = opts.shadow!==false; } update(dt){ this.vx = 0; this.vy = 0; if(this.move){ if(this.move.axis==='x'){ this.x += this.move.speed * this.move.dir * dt; this.vx = this.move.speed * this.move.dir; if(this.x < this.move.min){ this.x = this.move.min; this.move.dir = 1; } if(this.x + this.w > this.move.max){ this.x = this.move.max - this.w; this.move.dir = -1; } }else{ this.y += this.move.speed * this.move.dir * dt; this.vy = this.move.speed * this.move.dir; if(this.y < this.move.min){ this.y = this.move.min; this.move.dir = 1; } if(this.y + this.h > this.move.max){ this.y = this.move.max - this.h; this.move.dir = -1; } } } } draw(ctx, cam){ const x = this.x - cam.x, y = this.y - cam.y; if(this.shadow){ ctx.fillStyle = 'rgba(0,0,0,0.25)'; ctx.fillRect(x+6,y+8,this.w, this.h); } const radius = 8; ctx.fillStyle = this.color; roundRect(ctx, x, y, this.w, this.h, radius, true, false); ctx.fillStyle = this.topColor; roundRect(ctx, x, y, this.w, 10, {tl:radius,tr:radius,br:0,bl:0}, true, false); ctx.fillStyle = 'rgba(255,255,255,0.12)'; for(let i=10;i<this.w-8;i+=32){ ctx.fillRect(x+i, y+14, 6, 2); } } }
  class Coin { constructor(x,y){ this.x=x; this.y=y; this.r = 10; this.collected = false; this.t = Math.random()*10; this.bob = rand(0, Math.PI*2); } update(dt){ this.t += dt; } draw(ctx, cam){ if(this.collected) return; const t = this.t; const s = 0.55 + 0.45 * Math.abs(Math.cos(t*3)); const bob = Math.sin(t*4 + this.bob)*3; const cx = this.x - cam.x, cy = this.y - cam.y + bob; ctx.save(); ctx.translate(cx, cy); ctx.scale(s, 1); const r = this.r; ctx.fillStyle = '#f7b50022'; ctx.beginPath(); ctx.arc(0,0,r+10,0,Math.PI*2); ctx.fill(); const grad = ctx.createRadialGradient(-3,-3,1, 0,0,r); grad.addColorStop(0,'#fff8cc'); grad.addColorStop(0.4,'#ffe066'); grad.addColorStop(1,'#d49900'); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle = 'rgba(100,60,0,0.5)'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(0,0,r-5,0,Math.PI*2); ctx.stroke(); ctx.fillStyle = '#ffffffaa'; ctx.beginPath(); ctx.arc(-5,-5,2,0,Math.PI*2); ctx.fill(); ctx.restore(); } aabb(){ return {x:this.x - this.r, y:this.y - this.r, w:this.r*2, h:this.r*2}; } }
  class Spike { constructor(x,y,w=32,h=24){ this.x=x; this.y=y; this.w=w; this.h=h; } draw(ctx, cam){ const x = this.x - cam.x, y = this.y - cam.y; const n = Math.max(1, Math.floor(this.w/16)); const base = this.h; ctx.fillStyle = '#0a0f22'; ctx.fillRect(x+4, y+base+3, this.w-8, 4); for(let i=0;i<n;i++){ const sx = x + (i+0.1)*this.w/n; const w = this.w/n*0.8; ctx.beginPath(); ctx.moveTo(sx, y+base); ctx.lineTo(sx + w*0.5, y); ctx.lineTo(sx + w, y+base); ctx.closePath(); const grd = ctx.createLinearGradient(0,y,0,y+base); grd.addColorStop(0,'#e8f0ff'); grd.addColorStop(1,'#96a4c7'); ctx.fillStyle = grd; ctx.fill(); ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 1; ctx.stroke(); } } aabb(){ return {x:this.x, y:this.y, w:this.w, h:this.h}; } }
  class Goal { constructor(x,y){ this.x=x; this.y=y; this.w=40; this.h=80; this.t=0; } update(dt){ this.t += dt; } draw(ctx, cam){ const x = this.x - cam.x, y = this.y - cam.y; ctx.fillStyle = '#dedff6'; roundRect(ctx, x, y - this.h, 10, this.h+10, 5, true, false); const flutter = Math.sin(this.t*4)*6; ctx.save(); ctx.translate(x+10, y - this.h + 10); ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(28+flutter*0.3,10, 40+flutter, 0); ctx.quadraticCurveTo(28+flutter*0.3,-10, 0, -6); ctx.closePath(); const grd = ctx.createLinearGradient(0,-10,40,10); grd.addColorStop(0,'#5effc8'); grd.addColorStop(1,'#00cd8b'); ctx.fillStyle = grd; ctx.fill(); ctx.restore(); ctx.fillStyle = '#00ffbb22'; ctx.beginPath(); ctx.arc(x+10, y - this.h + 6, 36, 0, Math.PI*2); ctx.fill(); } aabb(){ return {x:this.x, y:this.y - this.h, w:this.w, h:this.h}; } }

  // Particles & Helpers (Same as yours)
  const particles = []; let showParticles = true;
  function spawnBurst(x,y,color='#ffffff',count=10,spd=180, life=0.5){ if(!showParticles) return; for(let i=0;i<count;i++) particles.push({ x,y, vx: rand(-1,1)*spd, vy: rand(-1, -0.2)*spd, life: life, t:0, color:color, size: rand(1.5,3.5) }); }
  function updateParticles(dt){ for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.t += dt; p.x += p.vx * dt; p.y += p.vy * dt; p.vy += 900*dt; if(p.t >= p.life) particles.splice(i,1); } }
  function drawParticles(ctx, cam){ if(!showParticles) return; particles.forEach(p=>{ const a = 1 - p.t/p.life; ctx.fillStyle = hexToRgba(p.color, a*0.9); ctx.beginPath(); ctx.arc(p.x - cam.x, p.y - cam.y, p.size, 0, Math.PI*2); ctx.fill(); }); }
  function hexToRgba(hex,a){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return rgba(${r},${g},${b},${a}); }
  function aabbIntersect(a,b){ return !(a.x+a.w<=b.x || a.x>=b.x+b.w || a.y+a.h<=b.y || a.y>=b.y+b.h); }
  function roundRect(ctx, x, y, w, h, r, fill, stroke){ let tl, tr, br, bl; if(typeof r==='number') tl=tr=br=bl=r; else ({tl=0,tr=0,br=0,bl=0} = r); ctx.beginPath(); ctx.moveTo(x+tl, y); ctx.lineTo(x+w-tr, y); ctx.quadraticCurveTo(x+w, y, x+w, y+tr); ctx.lineTo(x+w, y+h-br); ctx.quadraticCurveTo(x+w, y+h, x+w-br, y+h); ctx.lineTo(x+bl, y+h); ctx.quadraticCurveTo(x, y+h, x, y+h-bl); ctx.lineTo(x, y+tl); ctx.quadraticCurveTo(x, y, x+tl, y); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }
  const camera = { x:0, y:0, shakeT:0, shakeMag:0 };
  function shake(mag=8, time=0.18){ camera.shakeMag = Math.max(camera.shakeMag, mag); camera.shakeT = Math.max(camera.shakeT, time); if(navigator.vibrate) navigator.vibrate(30); }

  const player = { x:0, y:0, vx:0, vy:0, w:PLAYER.w, h:PLAYER.h, onGround:false, ground:null, coyote:0, extraJumps:1, face:1, invuln:0, alive:true, landed:false, animT:0 };
  const solids = []; const coins = []; const spikes = []; let goal = null;
  let state = 'menu'; let timeStart = 0; let runTime = 0; let coinCount = 0; let bestTime = parseFloat(localStorage.getItem('skybound_best')||'NaN');

  function resetPlayer(){ player.vx=player.vy=0; player.onGround=false; player.ground=null; player.coyote=0; player.extraJumps=1; player.face=1; player.alive=true; player.invuln=0; player.animT=0; player.x = levelSpawn.x; player.y = levelSpawn.y - player.h; }
  let levelSpawn = {x:60, y:520};
  function generateLevel(seed = Math.random()*1e9){
    Math.seed = seed; solids.length = 0; coins.length = 0; spikes.length = 0; particles.length = 0; goal = null;
    const baseY = 560; let x = -40; solids.push(new Platform(x, baseY, 320, 26, {color:'#253c6b', topColor:'#3a67c4'})); levelSpawn = {x: x+50, y: baseY};
    let prevY = baseY-4; let lastW = 320;
    for(let i=0;i<30;i++){
      const gap = rand(90, 230); x += lastW + gap; const w = rand(140, 300); prevY = clamp(prevY + rand(-120, 120), 200, 620); const y = prevY;
      if(Math.random() < 0.22){
        const axis = Math.random() < 0.55 ? 'x' : 'y';
        if(axis==='x') solids.push(new Platform(x, y, w, 22, {color:'#20345e', topColor:'#2f58a6', move:{axis:'x', min:x-80, max:x+120, speed: irand(45, 85), dir: Math.random()<0.5?-1:1}}));
        else solids.push(new Platform(x, y, w, 22, {color:'#20345e', topColor:'#2f58a6', move:{axis:'y', min:y-80, max:y+80, speed: irand(45, 80), dir: Math.random()<0.5?-1:1}}));
      } else solids.push(new Platform(x, y, w, 22, {color:'#253c6b', topColor:'#3a67c4'}));
      lastW = w; const cnum = irand(2,4); for(let c=0;c<cnum;c++) coins.push(new Coin(x + (w/(cnum+1))*(c+1), y - rand(36, 64)));
      if(Math.random()<0.35 && w>180){ const sW = irand(24, Math.min(120, w-40)); spikes.push(new Spike(x + rand(20, w - sW - 20), y - 24, sW, 24)); }
    }
    for(let k=0;k<5;k++){ const px = x + 180 + k*220 + rand(-40,40); const py = clamp(520 - k*24 + rand(-20, 20), 220, 600); solids.push(new Platform(px, py, irand(100,180), 30, {color:'#263f72', topColor:'#3b6cd1'})); coins.push(new Coin(px + 40, py - 40)); }
    const endX = x + 1100; const finalY = clamp(prevY - 20, 240, 560); solids.push(new Platform(endX - 120, finalY + 60, 260, 20, {color:'#1d325e', topColor:'#2d5bad'})); goal = new Goal(endX, finalY + 60); WORLD.width = endX + 400;
  }

  function startGame(){
    hideAllOverlays(); state = 'playing'; resumeAudio();
    runTime = 0; coinCount = 0; hudCoin.textContent = '0'; timeStart = performance.now();
    camera.x = 0; camera.y = 0; camera.shakeT=0; generateLevel(); resetPlayer();
    if(crazySDK) crazySDK.game.gameplayStart();
  }
  function gameOver(){
    if(state!=='playing') return;
    state = 'over'; sfx('death'); shake(12,0.4); showOverlay(overOverlay);
    overStats.innerHTML = Coins: <b>${coinCount}</b> &nbsp;‚Ä¢&nbsp; Time: <b>${formatTime(runTime)}</b>;
    if(crazySDK) crazySDK.game.gameplayStop();
    requestAd(); // Offer ad after death
  }
  function win(){
    if(state!=='playing') return;
    state = 'win'; sfx('win'); showOverlay(winOverlay);
    winStats.innerHTML = Coins: <b>${coinCount}</b> &nbsp;‚Ä¢&nbsp; Time: <b>${formatTime(runTime)}</b>;
    if(!isFinite(bestTime) || runTime < bestTime){ bestTime = runTime; localStorage.setItem('skybound_best', String(bestTime)); }
    updateHUD(); if(crazySDK) crazySDK.game.gameplayStop();
  }
  function restart(){ startGame(); }
  function showOverlay(el){ hideAllOverlays(); el.classList.remove('hidden'); }
  function hideAllOverlays(){ startOverlay.classList.add('hidden'); pauseOverlay.classList.add('hidden'); settingsOverlay.classList.add('hidden'); winOverlay.classList.add('hidden'); overOverlay.classList.add('hidden'); }
  function formatTime(t){ return (Math.round(t*10)/10).toFixed(1); }
  function updateHUD(){ hudCoin.textContent = coinCount; hudTime.textContent = formatTime(runTime); hudBest.textContent = isFinite(bestTime) ? formatTime(bestTime) : '‚Äî'; }

  loadSettings(); updateHUD();
  let last = performance.now();
  function loop(now){ const rawDt = Math.min(0.033, (now - last)/1000); last = now; if(state === 'playing' || state === 'menu'){ const steps = Math.max(1, Math.round(rawDt / (1/120))); for(let i=0;i<steps;i++) tick(rawDt / steps); } draw(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  function tick(dt){
    if(state==='playing'){ runTime += dt; updateHUD(); }
    solids.forEach(p=>p.update(dt)); coins.forEach(c=>c.update(dt)); if(goal) goal.update(dt);
    if(state==='playing') handlePlayer(dt);
    const cw = canvas.clientWidth; const targetX = clamp(player.x + player.w*0.5 - cw*0.45, 0, Math.max(0, WORLD.width - cw)); camera.x += (targetX - camera.x) * 0.12; if(camera.shakeT > 0) camera.shakeT -= dt;
    updateParticles(dt);
  }

  function handlePlayer(dt){
    player.animT += dt; if(player.invuln>0) player.invuln -= dt;
    const accel = player.onGround ? MOVE_ACCEL_GROUND : MOVE_ACCEL_AIR;
    const dir = (input.right?1:0) - (input.left?1:0);
    if(dir!==0){ player.vx += accel * dir * dt; player.face = dir; } else if(player.onGround) player.vx -= Math.min(Math.abs(player.vx), FRICTION*dt) * sign(player.vx);
    player.vx = clamp(player.vx, -MAX_RUN, MAX_RUN);
    if(input.jumpPressed){ input.jumpBuffer = JUMP_BUFFER; input.jumpPressed = false; }
    if(input.jumpBuffer>0) input.jumpBuffer -= dt;
    if(player.onGround) player.coyote = COYOTE_TIME; else if(player.coyote>0) player.coyote -= dt;
    if(input.jump && input.jumpBuffer>0){
      if(player.onGround || player.coyote>0){ player.vy = -JUMP_VEL; player.onGround = false; player.coyote = 0; input.jumpBuffer = 0; player.extraJumps = 1; sfx('jump'); spawnBurst(player.x+player.w/2, player.y+player.h, '#88d0ff', 12, 220, 0.35); }
      else if(player.extraJumps>0){ player.vy = -JUMP_VEL*0.95; player.extraJumps--; input.jumpBuffer=0; sfx('jump'); spawnBurst(player.x+player.w/2, player.y+player.h, '#ffd188', 10, 240, 0.3); }
    }
    if(!input.jump && player.vy < 0) player.vy += GRAVITY*(CUT_GRAVITY_MULT-1)*dt;
    player.vy += GRAVITY*dt;
    const newX = player.x + player.vx*dt; const newY = player.y + player.vy*dt;
    let rect = {x:newX, y:player.y, w:player.w, h:player.h}; let collidedX = false;
    for(const s of solids){ if(aabbIntersect(rect, s)){ if(player.vx>0) rect.x = s.x - player.w; else if(player.vx<0) rect.x = s.x + s.w; player.vx = 0; collidedX=true; } }
    player.x = rect.x; rect = {x:player.x, y:newY, w:player.w, h:player.h}; let groundedOn = null;
    for(const s of solids){ if(aabbIntersect(rect, s)){ if(player.vy>0){ rect.y = s.y - player.h; groundedOn = s; } else if(player.vy<0) rect.y = s.y + s.h; player.vy = 0; } }
    player.y = rect.y; const wasOnGround = player.onGround; player.onGround = groundedOn!==null; player.ground = groundedOn;
    if(player.onGround && !wasOnGround) sfx('land');
    if(player.onGround && player.ground) player.x += player.ground.vx * dt;
    const pBox = {x:player.x, y:player.y, w:player.w, h:player.h};
    for(const c of coins) if(!c.collected && aabbIntersect(pBox, c.aabb())){ c.collected = true; coinCount++; hudCoin.textContent = coinCount; sfx('coin'); spawnBurst(c.x, c.y, '#ffd85a', 14, 260, 0.6); }
    for(const sp of spikes) if(aabbIntersect(pBox, sp.aabb())) return gameOver();
    if(goal && aabbIntersect(pBox, goal.aabb())) return win();
    if(player.y > 1200) return gameOver();
  }

  // Draw Functions (Same as yours)
  function draw(){ const w = canvas.clientWidth, h = canvas.clientHeight; ctx.clearRect(0,0,w,h); const cam = {x: camera.x + (camera.shakeT>0?(Math.random()*2-1)*camera.shakeMag:0), y: camera.y}; drawBackdrop(w,h); drawMountains(w,h, camera.x*0.2, '#0e1a36', 0.8); drawMountains(w,h, camera.x*0.35, '#13224a', 0.6); drawClouds(w,h, camera.x*0.1); solids.forEach(p=>p.draw(ctx, cam)); spikes.forEach(s=>s.draw(ctx, cam)); coins.forEach(c=>c.draw(ctx, cam)); if(goal) goal.draw(ctx, cam); drawPlayer(ctx, cam); drawParticles(ctx, cam); const grad = ctx.createRadialGradient(w*0.5,h*0.4, Math.min(w,h)*0.2, w*0.5,h*0.4, Math.max(w,h)*0.9); grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,0,0,0.4)'); ctx.fillStyle = grad; ctx.fillRect(0,0,w,h); }
  function drawBackdrop(w,h){ ctx.save(); ctx.fillStyle = '#ffffff'; const seed = Math.floor(camera.x*0.05); for(let i=0;i<40;i++){ const sx = ((i*97 + seed*23) % w); const sy = ((i*167 + seed*59) % (h*0.6)); ctx.globalAlpha = 0.15 + ((i*37)%10)/50; ctx.beginPath(); ctx.arc(sx, sy+30, 1, 0, Math.PI*2); ctx.fill(); } ctx.restore(); }
  function drawMountains(w,h, offset, color, alpha=0.7){ ctx.save(); ctx.globalAlpha = alpha; ctx.fillStyle = color; ctx.beginPath(); const baseY = h*0.82; ctx.moveTo(-100, baseY); for(let x=-100; x<w+100; x+=180){ ctx.lineTo(x+60, baseY - (80 + Math.sin((x+offset)*0.002)*40 + Math.cos((x+offset)*0.004)*30)); ctx.lineTo(x+180, baseY); } ctx.lineTo(w+120, h+120); ctx.lineTo(-120, h+120); ctx.closePath(); ctx.fill(); ctx.restore(); }
  function drawClouds(w,h, offset){ ctx.save(); ctx.globalAlpha = 0.28; for(let i=0;i<6;i++) drawCloud(((i*400 - offset*0.6) % (w+600)) - 200, 80 + (i%3)*40 + Math.sin((i*57 + performance.now()*0.0002))*10, 140); ctx.restore(); }
  function drawCloud(x,y,size){ ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.beginPath(); ctx.arc(x, y, size*0.3, 0, Math.PI*2); ctx.arc(x+size*0.25, y-10, size*0.24, 0, Math.PI*2); ctx.arc(x+size*0.5, y+6, size*0.28, 0, Math.PI*2); ctx.fill(); }
  function drawPlayer(ctx, cam){ const x = Math.round(player.x - cam.x), y = Math.round(player.y - cam.y), w = player.w, h = player.h; ctx.fillStyle = 'rgba(0,0,0,0.35)'; ctx.beginPath(); ctx.ellipse(x + w*0.5, y + h + 8, w*0.4, 6, 0, 0, Math.PI*2); ctx.fill(); const bob = player.onGround ? Math.sin(player.animT*20 * (Math.abs(player.vx)/MAX_RUN)) * 2 : 0; ctx.save(); ctx.translate(x + w/2, y + h/2 + bob); ctx.scale(player.face, 1); ctx.fillStyle = '#20345e'; roundRect(ctx, -w*0.47, -h*0.1, 10, 18, 3, true, false); ctx.fillStyle = '#1f3b7a'; roundRect(ctx, -10, 6, 8, 20, 3, true, false); roundRect(ctx, 2, 6, 8, 20, 3, true, false); const torsoGrad = ctx.createLinearGradient(0,-20,0,16); torsoGrad.addColorStop(0,'#3a7bff'); torsoGrad.addColorStop(1,'#2156d6'); ctx.fillStyle = torsoGrad; roundRect(ctx, -12, -18, 24, 34, 6, true, false); ctx.fillStyle = '#ffe1c1'; roundRect(ctx, -11, -34, 22, 18, 6, true, false); ctx.fillStyle = '#0d1a3a'; ctx.fillRect(-5, -28, 4, 4); ctx.fillRect(1, -28, 4, 4); ctx.restore(); }

  generateLevel(); resetPlayer();
})();
</script>
</body>
</html>
